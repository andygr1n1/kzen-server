import{O as v,P as f,J as j,j as t,o as k,aF as E,ab as I}from"./index-Cx9aHWms.js";import{u as d,S as p,X as L,a as z,F as D}from"./formik.esm-ADxEa5mi.js";import{I as g}from"./IconInfiniteLoading-BhfJWl73.js";import{l as $,r as A,T as V}from"./antd-bK47dtYc.js";import{n as q,u as x,b as R,a as N}from"./provider-IGjFkmm5.js";import{f as M,c as _}from"./date.helpers-BWySBUrV.js";import{b as y}from"./types-8-lvdrKU.js";import{a as O,F as b,u as B,s as X,i as U}from"./ProtectedRoutes-BInEfiaw.js";import{n as F,N as K,g as P,u as C,a as W,b as H,c as J,d as Q}from"./NotesCmsIndex-DAZ2lV8l.js";import{X as G}from"./XTooltip-Bdc9vu0b.js";import"./types-BpX3pQkR.js";import{X as Y,e as Z}from"./XTiptap-Ch2jQgok.js";import{h as ee}from"./react-day-picker-BMg2DGmo.js";import{c as te}from"./cn-Bz47sbbS.js";import{I as se}from"./IconHeart-CwlJhkiG.js";import{u as ae}from"./useMutation-D6aZmw1J.js";import"./useMatchMedia.hook-CVR6FWmx.js";import"./IconNew-BhAnMb5r.js";import"./IconCheck-DtfZ8jdC.js";import"./XSkeleton-x0yqnB_E.js";import"./IconSearch-CPJHC6Kt.js";import"./debounce-CqMFxJgi.js";import"./NoteEditorDialog-Cv0uILeF.js";const oe=async e=>{try{const{id:s}=e;if(!s)return;const a=await v(),o=f(`
                query query_fetchNote($id: uuid!) {
                    notes_by_pk(id: $id) {
                        ...NoteResponseFr
                    }
                }
            `,[F]),r=await a.request(o,{id:s});return y.parse(r.notes_by_pk)}catch(s){return await j(s)}},ne=e=>{const{id:s}=e,{isLoading:a,data:o}=O({queryKey:q.useFetchNote({id:s}),queryFn:async()=>await oe({id:s}),staleTime:1e3,refetchOnWindowFocus:!1,refetchOnMount:!0,enabled:!!s});return{isLoading:a,data:o}},S=()=>{const{store:e}=x(),{isLoading:s,data:a}=ne({id:e.id});return{isLoading:s,data:a}},w=()=>{const{store:e}=x(),{isLoading:s,data:a}=S(),o=ie();return{store:e,initialValues:a||o,isLoading:s}},ie=()=>({id:crypto.randomUUID(),created_at:M(),deleted_at:null,is_favorite:!1,archived:!1,description:"",tag:"",label_id:null,label:{name:""}}),re=()=>({OkText:"Save",tooltipText:"",disabled:!1,isSubmitting:d().isSubmitting}),le=()=>{const{disabled:e,OkText:s,tooltipText:a,isSubmitting:o}=re();return t.jsxs("div",{className:"relative",children:[t.jsx(p,{variant:"outlined",type:"submit",disabled:e||o,size:"small",className:"z-10",children:o?t.jsx(g,{className:"w-6 h-6"}):s}),e&&a&&t.jsx("div",{id:"disabledTooltip",className:`pointer-events-auto absolute left-0 top-0
                    z-20 h-full w-full rounded-lg bg-transparent`}),e&&a&&t.jsx(G,{anchorSelect:"#disabledTooltip",children:a})]})},ce=()=>{const e=d(),{isLoading:s,data:a}=S();return t.jsxs("div",{className:"relative pb-2",children:[t.jsx(b,{title:"Description *"}),t.jsx(Y,{isLoading:s,content:(a==null?void 0:a.description)||"",onChange:o=>e.setFieldValue("description",o),readonly:!1,error:e.touched.description&&!!e.errors.description,errorMessage:e.errors.description})]})},de=()=>{const e=d(),{created_at:s}=e.values,a=ue(e.values),o=a?`${a} ${a===1?"day":"days"} ago`:"today";return t.jsx(t.Fragment,{children:s&&t.jsx("div",{className:"flex items-center gap-2 font-extralight text-xs min-w-fit",children:o})})},ue=e=>{if(!e.created_at)return 0;const s=e.created_at,a=Date.now(),o=_(s).getTime(),r=new Date(a-o);return Math.floor(r.getTime()/(1e3*3600*24))},me=()=>{const s=d().values.created_at;return s?t.jsxs("div",{className:"flex items-center gap-2 mb-5 opacity-80 flex-wrap",children:[t.jsx("div",{className:"font-extralight text-xs min-w-fit",children:"created"}),t.jsx(de,{}),t.jsxs("div",{className:"font-extralight text-xs min-w-fit",children:["on ",ee(_(s),"do MMMM yyyy, EEEE")]})]}):null},pe=k(()=>{const e=d(),{tagInput:s,onChangeField:a}=R(),o=n=>{const l=E(n==null?void 0:n.split(",").map(c=>c.trim().toLowerCase())).slice();return!!s.length&&!l.includes(s.trim().toLowerCase())},r=n=>{const{noteTags:l}=P(e.values.tag);if(!l.length)return;const c=l.filter(u=>u!==n);e.setFieldValue("tag",c.toString())};return t.jsxs("div",{children:[t.jsx(b,{title:"Tag:"}),t.jsxs("div",{className:"mb-2 flex w-full items-center gap-2 ",children:[t.jsx(L,{value:s,onChange:n=>a("tagInput",n.target.value)}),t.jsx(p,{disabled:!o(e.values.tag),onClick:()=>{const n=e.values.tag?e.values.tag+",":"";e.setFieldValue("tag",n+B(s.split(",").map(l=>l.trim())).join(",")),a("tagInput","")},children:"Add"})]}),t.jsx(K,{note:e.values,deleteAction:r})]})}),xe=e=>t.jsx($,{...e,rootClassName:"x-autocomplete-root",popupClassName:"x-autocomplete-popup-root",className:"x-autocomplete",style:{height:40},filterOption:(s,a)=>{var o,r,n;return((n=(r=(o=a==null?void 0:a.value)==null?void 0:o.toString())==null?void 0:r.toUpperCase())==null?void 0:n.indexOf(s.toUpperCase()))!==-1}}),fe=({handleSelect:e})=>{const{notesLabels:s}=C(),a=d();return t.jsx("div",{className:"flex gap-2 mt-4 flex-wrap",children:X(s,["rating"]).reverse().slice(0,4).map(o=>t.jsx(p,{onClick:()=>{e(o.id)},size:"small",variant:o.id===a.values.label_id?"contained":"outlined",className:"capitalize",children:o.name},o.name))})},ge=()=>{var u;const{isLoading:e,data:s,onChange:a,filter:o,notesLabels:r}=C(),n=d();A.useEffect(()=>{var i;a(((i=n.values.label)==null?void 0:i.name)||"")},[(u=n.values.label)==null?void 0:u.name]);const l=i=>{var h;const m=((h=r.find(T=>T.id===i))==null?void 0:h.name)||"";a(m),n.setFieldValue("label_id",i||null)},c=()=>{a(""),n.setFieldValue("label_id",null)};return t.jsxs("div",{className:"w-full flex flex-col",children:[t.jsx(b,{title:"Label:"}),t.jsx(xe,{suffixIcon:e&&t.jsx("div",{className:"w-5 h-5 ",children:t.jsx(g,{className:"text-blue-500"})}),disabled:e,filterOption:!1,allowClear:!0,className:"x-autocomplete",style:{height:40},options:s.map(i=>({label:i.name,value:i.name,id:i.id})),searchValue:o,onSearch:i=>a(i),value:U(o),onSelect:(i,m)=>{l(m.id)},onBlur:()=>{var i;n.values.label_id?a(((i=r.find(m=>m.id===n.values.label_id))==null?void 0:i.name)||""):a("")},onClear:c,optionRender:i=>t.jsx("div",{className:te("h-10 text-base flex items-center capitalize",i.data.id===n.values.label_id&&"!text-blue-500"),children:i.value})}),t.jsx(fe,{handleSelect:l})]})},be=()=>t.jsxs(t.Fragment,{children:[t.jsx(me,{}),t.jsxs("div",{className:"flex flex-col gap-5",children:[t.jsx(ce,{}),t.jsx(ge,{}),t.jsx(pe,{})]})]}),he=()=>({noteEditorTabs:[{key:"1",label:"Note",children:t.jsx(be,{})}]}),Ne=()=>{const{noteEditorTabs:e}=he();return t.jsx(V,{className:"[&_.ant-tabs-nav::before]:border-slate-500 ",tabBarStyle:{position:"sticky",top:-20,background:"var(--colors-global-2-bg-plasma)",zIndex:10},defaultActiveKey:"1",items:e,tabBarExtraContent:t.jsx(le,{}),indicator:{align:"center"}})},ve=()=>{const e=d(),s=e.values.is_favorite;return t.jsx(t.Fragment,{children:t.jsx(p,{id:"toggleFavoriteNote",error:!!s,variant:s?"contained":"text",size:"small",onClick:()=>{e.setFieldValue("is_favorite",!s)},startIcon:t.jsx(se,{className:"mb-0.5 h-6 w-6 opacity-70 hover:opacity-100"})})})},je=()=>{const{store:e}=x(),s=d();return t.jsxs("div",{className:"relative flex w-full min-h-[32px] flex-wrap items-center justify-center gap-5",children:[e.id?t.jsx(W,{id:e.id,isFavorite:!!s.values.is_favorite}):t.jsx(ve,{}),e.id&&t.jsx(H,{id:e.id,isArchived:!!s.values.archived}),e.id&&t.jsx(J,{id:e.id,deletedAt:!!s.values.deleted_at})]})},_e=()=>{const{isLoading:e}=w();return t.jsxs(z,{children:[e&&t.jsx("div",{className:"w-full h-full z-[100] bg-global-bg-plasma left-0 flex items-center duration-300 justify-center top-0 fixed",children:t.jsx(g,{className:"w-20 h-20 text-blue-500 duration-300"})}),t.jsx(je,{}),t.jsx(Ne,{})]})},ye=()=>({validate:s=>{const a={};return Z(s.description).length||(a.description="Required field"),a}}),Fe=async e=>{try{const s=await v(),{note:{label:a,...o}}=e,r=f(`
                mutation mutation_upsertNote($object: notes_insert_input!) {
                    insert_notes_one(
                        object: $object
                        on_conflict: { constraint: tasks_pkey, update_columns: [description, tag, label_id] }
                    ) {
                        ...NoteResponseFr
                    }
                }
            `,[F]),n=await s.request(r,{object:o}).then(c=>y.parse(c.insert_notes_one)),l=f(`
            mutation Mutation_updateNoteLabelRating($id: uuid!) {
                update_notes_labels_by_pk(pk_columns: { id: $id }, _inc: { rating: 1 }) {
                    id
                    name
                    owner_id
                    rating
                }
            }
        `);return o.label_id&&await s.request(l,{id:o.label_id}),n}catch(s){return await j(s)}},Ce=()=>{const{onSuccess:e}=Q(),s=ae({mutationFn:({note:o})=>Fe({note:o}),onSuccess:()=>{e()}});return{upsertNote:o=>{s.mutate({note:o.note},{onSuccess:o.onSuccess,onSettled:o.onSettled})}}},Se=()=>{const{onCancel:e}=x(),{upsertNote:s}=Ce();return{onSubmit:(o,r)=>{var c;const{setSubmitting:n}=r,l=N.tagInput;s({note:{...o,tag:l.length?`${o.tag||""}${(c=o.tag)!=null&&c.length?",":""}${l}`:o.tag},onSuccess:()=>{e(),r.resetForm(),N.onChangeField("tagInput",""),I("Note saved")},onSettled:()=>{n(!1)}})}}},Qe=()=>{const{onSubmit:e}=Se(),{validate:s}=ye(),{initialValues:a}=w();return t.jsx(D,{enableReinitialize:!0,initialValues:a,validate:s,onSubmit:e,children:t.jsx(_e,{})})};export{Qe as default};
//# sourceMappingURL=NoteEditor-CsMKzbZd.js.map
