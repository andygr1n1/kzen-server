import{j as s,P as h,O as f,J as p,o as C,Q as k,aH as z}from"./index-Cx9aHWms.js";import{a as x,b as S,c as I}from"./achResponseFr-DHzlt_Pk.js";import{u as c,S as g,X as T,a as N,F as D}from"./formik.esm-ADxEa5mi.js";import{I as y}from"./IconInfiniteLoading-BhfJWl73.js";import{T as E,r as V}from"./antd-bK47dtYc.js";import{I as $}from"./IconHeart-CwlJhkiG.js";import{u as a}from"./provider-CFg4W0mD.js";import{u as A,a as M,A as O,b as R}from"./AchToggleEdit-D8Nqb8YI.js";import{c as u}from"./cn-Bz47sbbS.js";import{u as F}from"./useMutation-D6aZmw1J.js";import{X as q}from"./XTooltip-Bdc9vu0b.js";import{b as L,c as U,p as X,f as B}from"./date.helpers-BWySBUrV.js";import{c as b}from"./index--O-lbexr.js";import{h as P,j}from"./react-day-picker-BMg2DGmo.js";import{X as W}from"./XDatePicker-6LcKFFPc.js";import{F as m,a as H}from"./ProtectedRoutes-BInEfiaw.js";import{X as K}from"./XTiptap-Ch2jQgok.js";import{I as Y}from"./ImgCropperDialog-DEU-JsqI.js";import{I as Q,U as G,u as J,a as Z}from"./image.service-CXyyVGKV.js";import"./IconNew-BhAnMb5r.js";import"./useMatchMedia.hook-CVR6FWmx.js";import"./XSkeleton-x0yqnB_E.js";const ee=()=>{const e=c(),t=e.values.is_favorite;return s.jsx(s.Fragment,{children:s.jsx(g,{id:"toggleFavoriteAch",error:!!t,variant:t?"contained":"text",size:"small",onClick:()=>{e.setFieldValue("is_favorite",!t)},startIcon:s.jsx($,{className:"mb-0.5 h-6 w-6 opacity-70 hover:opacity-100"})})})};function te(e){return s.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"0.88rem",height:"1rem",viewBox:"0 0 448 512",...e,children:s.jsx("path",{fill:"currentColor",d:"M224 0c17.7 0 32 14.3 32 32v30.1l15-15c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9l-49 49v70.3l61.4-35.8L335 98.4c3.4-12.8 16.6-20.4 29.4-17s20.4 16.6 17 29.4l-5.2 19.3l23.6-13.8c15.3-8.9 34.9-3.7 43.8 11.5s3.8 34.9-11.5 43.8l-25.3 14.8l21.7 5.8c12.8 3.4 20.4 16.6 17 29.4s-16.6 20.4-29.4 17l-67.7-18.1l-60.9 35.5l60.9 35.5l67.7-18.1c12.8-3.4 26 4.2 29.4 17s-4.2 26-17 29.4l-21.7 5.8l25.3 14.8c15.3 8.9 20.4 28.5 11.5 43.8s-28.5 20.4-43.8 11.5l-23.6-13.8l5.2 19.3c3.4 12.8-4.2 26-17 29.4s-26-4.2-29.4-17l-17.7-66.1l-61.3-35.8V382l49 49c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0l-15-15V480c0 17.7-14.3 32-32 32s-32-14.3-32-32v-30.1l-15 15c-9.4 9.4-24.6 9.4-33.9 0s-9.4-24.6 0-33.9l49-49v-70.3l-61.4 35.8l-17.7 66.1c-3.4 12.8-16.6 20.4-29.4 17s-20.4-16.6-17-29.4l5.2-19.3l-23.8 13.7c-15.3 8.9-34.9 3.7-43.8-11.5s-3.7-34.9 11.5-43.8l25.3-14.8l-21.7-5.8c-12.8-3.4-20.4-16.6-17-29.4s16.6-20.4 29.4-17l67.7 18.1l61-35.4l-60.9-35.5l-67.7 18.1c-12.8 3.4-26-4.2-29.4-17s4.2-26 17-29.4l21.7-5.8l-25.3-14.8C.6 162.7-4.5 143.1 4.4 127.9s28.5-20.4 43.8-11.5l23.6 13.8l-5.2-19.3c-3.4-12.8 4.2-26 17-29.4s26 4.2 29.4 17l17.7 66.1l61.3 35.7V130l-49-49c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l15 15L192 32c0-17.7 14.3-32 32-32"})})}const se=async({id:e,freezed:t})=>{try{const r=h(`
                mutation mutation_updateAchFreezed($id: uuid!, $freezed: Boolean!) {
                    update_achievements_by_pk(pk_columns: { id: $id }, _set: { freezed: $freezed }) {
                        ...AchResponseFr
                    }
                }
            `,[x]);return await(await f()).request(r,{id:e,freezed:t})}catch(r){await p(r);return}},re=()=>{const{onSuccess:e}=A(),t=c(),{edit_id:r}=a(),o=F({mutationFn:n=>se(n),onSuccess:e});return{freezeAch:()=>{const n=!t.values.freezed;t.setFieldValue("freezed",n),r&&o.mutate({id:r,freezed:n})},freezed:t.values.freezed}},oe=()=>{const{freezeAch:e,freezed:t}=re();return s.jsx(g,{onClick:e,variant:"text",startIcon:s.jsx(te,{className:u("w-[22px] h-[22px] opacity-70 hover:opacity-100",t&&"opacity-100 text-blue-500")})})},ie=()=>{const{edit_id:e}=a(),t=c();return s.jsxs("div",{className:"relative flex w-full min-h-[32px] flex-wrap items-center justify-center gap-5",children:[e&&s.jsx(M,{id:e}),e?s.jsx(O,{id:e,isFavorite:!!t.values.is_favorite}):s.jsx(ee,{}),e&&s.jsx(R,{id:e,deletedAt:!!t.values.deleted_at}),s.jsx(oe,{})]})},ne=()=>({OkText:"Save",tooltipText:"",disabled:!1,isSubmitting:c().isSubmitting}),ce=()=>{const{disabled:e,OkText:t,tooltipText:r,isSubmitting:o}=ne();return s.jsxs("div",{className:"relative",children:[s.jsx(g,{variant:"outlined",type:"submit",disabled:e||o,size:"small",className:"z-10",children:o?s.jsx(y,{className:"w-6 h-6"}):t}),e&&r&&s.jsx("div",{id:"disabledTooltip",className:`pointer-events-auto absolute left-0 top-0
                    z-20 h-full w-full rounded-lg bg-transparent`}),e&&r&&s.jsx(q,{anchorSelect:"#disabledTooltip",children:r})]})},ae=()=>{const e=c(),{created_at:t}=e.values,r=L(b(e.values.created_at)),o=r?`${r} ${r===1?"day":"days"} ago`:"today";return s.jsx(s.Fragment,{children:t&&s.jsx("div",{className:"flex items-center gap-2 font-extralight text-xs min-w-fit",children:o})})},le=()=>{const t=c().values.created_at;return t?s.jsxs("div",{className:"flex items-center gap-2 mb-5 opacity-80 flex-wrap",children:[s.jsx("div",{className:"font-extralight text-xs min-w-fit",children:"created"}),s.jsx(ae,{}),s.jsxs("div",{className:"font-extralight text-xs min-w-fit",children:["on ",P(U(t),"do MMMM yyyy, EEEE")]})]}):null},de=()=>{const e=c(),{readonly:t}=a();function r(i){i&&e.setFieldValue("created_at",X(new Date(i)))}function o(){e.setFieldValue("created_at",null)}return s.jsxs("div",{children:[s.jsx(m,{title:"Date *"}),s.jsx(W,{numberOfMonths:1,mode:"single",selected:e.values.created_at?new Date(e.values.created_at):void 0,onSelect:r,dateFormat:"do MMMM yyyy",captionLayout:"dropdown-buttons",fromYear:j(new Date(Date.now()))-100,toYear:j(new Date(Date.now()))+100,fixedWeeks:!0,showOutsideDays:!0,showWeekNumber:!0,onClear:o,showToday:!0,disabled:t,readOnly:t})]})},ue=async({id:e})=>{try{const t=h(`
                query query_fetchAch($id: uuid!) {
                    achievements_by_pk(id: $id) {
                        ...AchResponseFr
                    }
                }
            `,[x]),o=await(await f()).request(t,{id:e});return o==null?void 0:o.achievements_by_pk}catch(t){return await p(t)}},me=e=>{const{id:t}=e,{isLoading:r,data:o,isFetching:i,isFetched:n}=H({queryKey:S.fetchAchKey(`${t}`),queryFn:async()=>await ue({id:b(t)}),staleTime:1e3,refetchOnWindowFocus:!1,refetchOnMount:!0,enabled:!!t});return{isLoading:r,data:o,isFetching:i,isFetched:n}},v=()=>{const{edit_id:e}=a(),{isLoading:t,data:r,isFetching:o,isFetched:i}=me({id:e});return{isLoading:t,data:r,isFetched:i,isFetching:o}},he=()=>{const{readonly:e}=a(),t=c(),{isLoading:r,data:o}=v();return s.jsxs("div",{className:"relative pb-2",children:[s.jsx(m,{title:"Description"}),s.jsx(K,{isLoading:r,content:(o==null?void 0:o.description)||"",onChange:i=>t.setFieldValue("description",i),readonly:e})]})},fe=()=>{const e=c(),{img_src_buffer:t,img_src:r}=e.values,o=async n=>{e.setFieldValue("img_src_buffer",void 0),e.setFieldValue("img_src",n==null?void 0:n.getCroppedCanvas().toDataURL())},i=async()=>{e.setFieldValue("img_src_buffer",void 0),e.setFieldValue("img_src",void 0)};return s.jsx(Y,{src:r,open:!!r&&!!t,onOk:o,onCancel:i})},pe=()=>{const{readonly:e}=a(),t=c(),{img_src:r,img_path:o}=t.values,i=w=>{J(w,_=>{t.setFieldValue("img_src",_),t.setFieldValue("img_src_buffer",_)})},n=t.touched.title&&!!t.errors.img_src,l=t.errors.img_src,d=o||r;return s.jsxs("div",{className:u(e&&"pointer-events-none select-none"),children:[s.jsx(m,{title:"Logo"}),s.jsxs("div",{"data-testid":"profile-avatar-index",className:u(`group relative mx-auto flex h-[300px] w-[calc(100%-40px)] p-5
                    items-center justify-center rounded-md border border-solid
                    border-blue-900 hover:border-blue-600 shadow-md transition-shadow duration-300`,n&&"border-red-500 hover:border-red-500",e&&"border-transparent"),children:[d&&s.jsx("img",{src:r||`https://firebunny-storage.b-cdn.net/kzen/achievements/${o}`||void 0,className:"absolute top-0 left-0 right-[120px] w-full h-full opacity-[0.04] rounded-md z-1"}),d&&s.jsx("img",{src:r||`https://firebunny-storage.b-cdn.net/kzen/achievements/${o}`||void 0,className:"absolute h-[300px] w-[300px] rounded-md z-10"}),!e&&s.jsx(Q,{width:64,height:64,className:u("duration-300 z-20 group-hover:text-blue-600 text-blue-900",n&&"text-red-900/50 group-hover:text-red-900")}),s.jsx(G,{onChange:i}),n&&l&&s.jsx("div",{"data-testid":"error-message",className:"font-kzen bg-global-3-bg absolute bottom-[-6px] left-2 z-20 m-0 rounded-full p-0 px-1 text-xs leading-3 text-red-700 ",children:l})]})]})},xe=()=>{const{readonly:e}=a(),t=c();return s.jsxs("div",{children:[s.jsx(m,{title:"Title *"}),s.jsx(T,{readOnly:e,"data-testid":"ach-title-input",autoFocus:!0,value:t.values.title,name:"title",onChange:t.handleChange,error:t.touched.title&&!!t.errors.title,errorMessage:t.errors.title})]})},ge=()=>s.jsxs("div",{className:"py-2",children:[s.jsx(le,{}),s.jsxs("div",{className:"flex flex-col gap-5",children:[s.jsx(xe,{}),s.jsx(he,{}),s.jsx(de,{}),s.jsx(pe,{}),s.jsx(fe,{})]})]}),be=()=>({editorTabs:[{key:"1",label:"Achievement",children:s.jsx(ge,{})}]}),ve=C(()=>{const{readonly:e}=a(),{editorTabs:t}=be();return s.jsx(E,{className:"[&_.ant-tabs-nav::before]:border-slate-500 ",tabBarStyle:{position:"sticky",top:-20,background:"var(--colors-global-2-bg-plasma)",zIndex:10},defaultActiveKey:"1",items:t,tabBarExtraContent:!e&&s.jsx(ce,{}),indicator:{align:"center"}})}),_e=()=>{const{isLoading:e}=v();return s.jsxs(N,{children:[e&&s.jsx("div",{className:"w-full h-full z-[100] bg-global-bg-plasma left-0 flex items-center duration-300 justify-center top-0 fixed",children:s.jsx(y,{className:"w-20 h-20 text-blue-500 duration-300"})}),s.jsx(ie,{}),s.jsx(ve,{})]})},je=async({values:e})=>{try{const t={id:e.id,title:e.title,description:e.description,img_path:e.img_path,is_favorite:e.is_favorite,freezed:e.freezed,created_at:e.created_at},r=h(`
                mutation mutation_upsertAch($object: achievements_insert_input!) {
                    insert_achievements_one(
                        object: $object
                        on_conflict: {
                            constraint: achievements_id_key
                            update_columns: [title, description, img_path, is_favorite, freezed, created_at]
                        }
                    ) {
                        ...AchResponseFr
                    }
                }
            `,[x]);return await(await f()).request(r,{object:t})}catch(t){return await p(t)}},ye=()=>{const{id:e}=k(),{onSuccess:t}=A(),r=F({mutationFn:async({values:i})=>{let n=i.img_path;return i.img_src&&(n=await Z({img:b(i.img_src),route:z.ACH_IMAGE_UPLOAD,userId:e})),je({values:{...i,img_path:n||null}})},onSuccess:t});return{upsertAch:({values:i,onSuccess:n,onSettled:l})=>{r.mutate({values:i},{onSuccess:n,onSettled:l})}}},Ae=()=>{const{onClose:e}=a(),{upsertAch:t}=ye();return{onSubmit:(o,i)=>{const{setSubmitting:n}=i;t({values:o,onSuccess:()=>{e()},onSettled:()=>{n(!1)}})}}},Fe=()=>({validate:t=>{var i,n;const r=I.safeParse(t),o={};if(!r.success)for(const l of r.error.issues){const d=l.path[0];o[d]=l.message}return t.title.length||(o.title="Required field"),!((i=t.img_path)!=null&&i.length)&&!((n=t.img_src)!=null&&n.length)&&(o.img_src="Required field"),o}}),we=()=>{const{data:e,isFetching:t,isFetched:r}=v();return{initialValues:V.useMemo(()=>Ce(e),[!!e,t,r])}},Ce=e=>({id:(e==null?void 0:e.id)||crypto.randomUUID(),created_at:(e==null?void 0:e.created_at)||B(),deleted_at:(e==null?void 0:e.deleted_at)||null,is_favorite:!!(e!=null&&e.is_favorite),title:(e==null?void 0:e.title)||"",description:(e==null?void 0:e.description)||"",img_path:(e==null?void 0:e.img_path)||"",archived:!!(e!=null&&e.archived),freezed:!!(e!=null&&e.freezed)}),Ye=()=>{const{onSubmit:e}=Ae(),{validate:t}=Fe(),{initialValues:r}=we();return s.jsx(D,{enableReinitialize:!0,initialValues:r,validate:t,onSubmit:e,children:s.jsx(_e,{})})};export{Ye as default};
//# sourceMappingURL=AchEditor-C8UpyWON.js.map
